{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Change Password</h2>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'account_profile' %}">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'account_password' %}">Password</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Alerts -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row mt-3">
        <div class="col-lg-6 col-md-8">
            <form id="password-form" method="POST" novalidate>
                {% csrf_token %}
                <div class="card border-0 rounded-4 shadow-sm">
                    <div class="card-body p-5">

                        <!-- Current Password -->
                        <div class="mb-4">
                            <label for="old_password" class="form-label fw-bold">Current Password <span
                                    class="text-danger">*</span></label>
                            <input type="password" id="old_password" name="old_password" class="form-control rounded-3"
                                placeholder="Enter your current password" required>
                            {% if form.errors.old_password %}
                            <small class="text-danger" id="strengthMessageCurrent"></small>
                            {% endif %}
                        </div>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label for="new_password1" class="form-label fw-bold">New Password <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" id="new_password1" name="new_password1"
                                    class="form-control rounded-start-3" placeholder="Enter your new password" required>
                                <span class="input-group-text bg-white rounded-end-3" style="cursor:pointer;"
                                    onclick="togglePassword('new_password1', 'icon_new1')">
                                    <i id="icon_new1" class="fa fa-eye-slash"></i>
                                </span>
                            </div>
                            <small id="strengthMessage" class="text-danger d-none"></small>
                            {% if form.errors.new_password1 %}
                            <small class="text-danger">{{ form.errors.new_password1.0 }}</small>
                            {% endif %}
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label for="new_password2" class="form-label fw-bold">Confirm New Password <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" id="new_password2" name="new_password2"
                                    class="form-control rounded-start-3" placeholder="Confirm your new password"
                                    required>
                                <span class="input-group-text bg-white rounded-end-3" style="cursor:pointer;"
                                    onclick="togglePassword('new_password2', 'icon_new2')">
                                    <i id="icon_new2" class="fa fa-eye-slash"></i>
                                </span>
                            </div>
                            <small id="matchMessage" class="text-danger d-none">Passwords do not match.</small>
                            {% if form.errors.new_password2 %}
                            <small class="text-danger">{{ form.errors.new_password2.0 }}</small>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary py-2 px-4">Update Password</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        }
    }

    function checkPasswordStrength(password) {
        const minLength = /.{8,}/;
        const upper = /[A-Z]/;
        const lower = /[a-z]/;
        const number = /[0-9]/;
        return (
            minLength.test(password) &&
            upper.test(password) &&
            lower.test(password) &&
            number.test(password)
        );
    }

    const newPassInput = document.getElementById('new_password1');
    const confirmPassInput = document.getElementById('new_password2');
    const oldPassInput = document.getElementById('old_password');

    const strengthMsg = document.getElementById('strengthMessage');
    const matchMsg = document.getElementById('matchMessage');
    const currentMsg = document.getElementById('strengthMessageCurrent'); // corrected name

    // live strength check
    newPassInput.addEventListener('input', () => {
        if (!checkPasswordStrength(newPassInput.value)) {
            strengthMsg.classList.remove('d-none');
            strengthMsg.classList.remove('text-success');
            strengthMsg.classList.add('text-danger');
            strengthMsg.textContent =
                'Password must be at least 8 characters and include uppercase, lowercase, and a number.';
        } else {
            strengthMsg.classList.remove('text-danger');
            strengthMsg.classList.add('text-success');
            strengthMsg.textContent = 'Strong password âœ…';
        }
    });

    // live confirm password match check
    confirmPassInput.addEventListener('input', () => {
        if (confirmPassInput.value !== newPassInput.value) {
            matchMsg.classList.remove('d-none');
        } else {
            matchMsg.classList.add('d-none');
        }
    });

    // on submit final validation
    document.getElementById('password-form').addEventListener('submit', (e) => {
        let valid = true;

        const oldPass = oldPassInput.value.trim();
        const newPass = newPassInput.value.trim();
        const confirmPass = confirmPassInput.value.trim();

        if (currentMsg) currentMsg.textContent = '';

        // Check current password required
        if (!oldPass) {
            if (currentMsg) currentMsg.textContent = 'Please enter your current password.';
            valid = false;
        }

        // Check strength
        if (!checkPasswordStrength(newPass)) {
            strengthMsg.classList.remove('d-none');
            valid = false;
        }

        // Match check
        if (newPass !== confirmPass) {
            matchMsg.classList.remove('d-none');
            valid = false;
        } else {
            matchMsg.classList.add('d-none');
        }

        if (!valid) e.preventDefault();
    });
</script>

{% endblock %}